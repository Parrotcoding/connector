<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Try Galaxy Mimic Enhanced Notepad & QR Fixes</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #connection-section, #apps-section { margin-bottom: 20px; }
    textarea { width: 100%; margin-bottom: 10px; }
    #app-tabs { list-style: none; padding: 0; display: flex; gap: 10px; cursor: pointer; }
    #app-tabs li { padding: 5px 10px; background: #eee; border: 1px solid #ccc; }
    #app-tabs li:hover { background: #ddd; }
    #ttt-board td { border: 1px solid #000; width: 60px; height: 60px; text-align: center; font-size: 24px; cursor: pointer; }
    #chat-window { border: 1px solid #ccc; height: 200px; overflow: auto; margin-bottom: 10px; padding: 5px; }
    #qr-code { margin-bottom: 10px; }
    #qr-scanner { width: 300px; height: 300px; margin-top: 10px; }
    #notepad-toolbar { margin-bottom: 5px; }
    #notepad-area { width: 100%; height: 200px; border: 1px solid #ccc; padding: 5px; overflow: auto; }
  </style>
</head>
<body>
  <h1>Try Galaxy Mimic Enhanced Notepad & QR Fixes</h1>
  <div id="connection-section">
    <button id="create-session-btn">Create Session (Initiator)</button>
    <button id="join-session-btn">Join Session (Receiver)</button>
    <div id="signal-section" style="display:none;">
      <p id="signal-instructions">
        <strong>Step 1:</strong> Copy the generated code and/or use the QR code below, then share it with your peer.
      </p>
      <textarea id="signal-output" placeholder="Signal code will appear here..." readonly></textarea>
      <div id="qr-code"></div>
      <p id="signal-paste">
        <strong>Step 2:</strong> Paste your peer's code below or use the QR scanner.
      </p>
      <textarea id="signal-input" placeholder="Paste remote signal code here"></textarea>
      <button id="submit-signal-btn">Submit Signal</button>
      <br>
      <button id="scan-qr-btn">Scan QR Code</button>
      <div id="qr-scanner" style="display:none;"></div>
    </div>
  </div>

  <div id="apps-section" style="display:none;">
    <h2>Mini Apps</h2>
    <ul id="app-tabs">
      <li data-app="chat">Chat</li>
      <li data-app="notepad">Notepad</li>
      <li data-app="tic-tac-toe">Tic Tac Toe</li>
    </ul>
    <div id="app-container">
      <!-- App content loads here -->
    </div>
  </div>

  <!-- Include SimplePeer from CDN -->
  <script src="https://unpkg.com/simple-peer/simplepeer.min.js"></script>
  <!-- Include QRCode.js library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- Include html5-qrcode library -->
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <script>
    let peer;
    let currentRole = ""; // "initiator" or "receiver"
    let chatHistory = [];         // Persist chat messages
    let notepadContent = "";      // Persist notepad content

    const createSessionBtn = document.getElementById("create-session-btn");
    const joinSessionBtn = document.getElementById("join-session-btn");
    const signalSection = document.getElementById("signal-section");
    const signalOutput = document.getElementById("signal-output");
    const signalInput = document.getElementById("signal-input");
    const submitSignalBtn = document.getElementById("submit-signal-btn");
    const appsSection = document.getElementById("apps-section");
    const appTabs = document.getElementById("app-tabs");
    const appContainer = document.getElementById("app-container");
    const qrCodeDiv = document.getElementById("qr-code");
    const scanQRBtn = document.getElementById("scan-qr-btn");
    const qrScannerDiv = document.getElementById("qr-scanner");
    let html5QrcodeScanner = null;
    let qrScannerInitialized = false;

    createSessionBtn.addEventListener("click", () => {
      currentRole = "initiator";
      console.log("Starting as initiator");
      startPeer(true);
      signalSection.style.display = "block";
    });

    joinSessionBtn.addEventListener("click", () => {
      currentRole = "receiver";
      console.log("Starting as receiver");
      startPeer(false);
      signalSection.style.display = "block";
    });

    submitSignalBtn.addEventListener("click", () => {
      const remoteSignal = signalInput.value;
      try {
        const signalData = JSON.parse(remoteSignal);
        console.log("Submitting remote signal:", signalData);
        peer.signal(signalData);
      } catch (e) {
        alert("Invalid signal data. Please ensure the code is copied correctly.");
      }
    });

    // QR code scanning functionality
    scanQRBtn.addEventListener("click", () => {
      qrScannerDiv.style.display = "block";
      if (!qrScannerInitialized) {
        html5QrcodeScanner = new Html5QrcodeScanner("qr-scanner", { fps: 15, qrbox: { width: 300, height: 300 }}, false);
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        qrScannerInitialized = true;
      } else {
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
      }
    });

    function onScanSuccess(decodedText, decodedResult) {
      console.log(`QR code scanned: ${decodedText}`);
      signalInput.value = decodedText;
      alert("QR Code scanned. Remote signal data filled.");
      if (html5QrcodeScanner) {
        html5QrcodeScanner.clear().then(_ => {
          qrScannerDiv.innerHTML = "";
          qrScannerDiv.style.display = "none";
          qrScannerInitialized = false;
        }).catch(error => {
          console.error("Failed to clear QR scanner.", error);
        });
      }
    }

    function onScanFailure(error) {
      console.warn(`QR code scan error: ${error}`);
    }

    // Generate a QR code for the local signal data
    function generateQRCode(text) {
      qrCodeDiv.innerHTML = "";
      new QRCode(qrCodeDiv, {
        text: text,
        width: 256,
        height: 256,
        correctLevel: QRCode.CorrectLevel.H
      });
    }

    // Initialize the SimplePeer connection
    function startPeer(isInitiator) {
      peer = new SimplePeer({ initiator: isInitiator, trickle: false });
      
      peer.on('signal', data => {
        console.log("Local signal data generated:", data);
        const signalString = JSON.stringify(data);
        signalOutput.value = signalString;
        generateQRCode(signalString);
      });

      peer.on('connect', () => {
        console.log("Peer connection established");
        alert("Connection established!");
        document.getElementById("connection-section").style.display = "none";
        appsSection.style.display = "block";
        setupApps();
      });

      peer.on('error', err => {
        console.error("Peer error:", err);
      });

      peer.on('data', data => {
        try {
          const message = JSON.parse(data);
          console.log("Received data:", message);
          if (message.app === "chat") {
            appendChatMessage("Remote: " + message.payload);
          } else if (message.app === "notepad") {
            notepadContent = message.payload;
            const notepadArea = document.getElementById("notepad-area");
            if (notepadArea) {
              notepadArea.innerHTML = notepadContent;
            }
          } else if (message.app === "tic-tac-toe") {
            handleTicTacToeMove(message.payload);
          }
        } catch (e) {
          console.error("Error parsing incoming data", e);
        }
      });
    }

    // Send data over the peer connection
    function sendData(app, payload) {
      const message = JSON.stringify({ app, payload });
      if (peer && peer.connected) {
        peer.send(message);
      } else {
        console.warn("Peer not connected, cannot send data");
      }
    }

    // --- Mini Apps Setup ---
    function setupApps() {
      appTabs.addEventListener("click", e => {
        if (e.target && e.target.dataset.app) {
          openApp(e.target.dataset.app);
        }
      });
      openApp("chat");
    }

    function openApp(appName) {
      appContainer.innerHTML = "";
      if (appName === "chat") {
        const chatDiv = document.createElement("div");
        chatDiv.innerHTML = `
          <div id="chat-window"></div>
          <input type="text" id="chat-input" placeholder="Type a message" />
          <button id="chat-send-btn">Send</button>
        `;
        appContainer.appendChild(chatDiv);
        renderChatHistory();
        document.getElementById("chat-send-btn").addEventListener("click", () => {
          const message = document.getElementById("chat-input").value;
          if(message.trim() !== ""){
            appendChatMessage("You: " + message);
            sendData("chat", message);
            document.getElementById("chat-input").value = "";
          }
        });
      } else if (appName === "notepad") {
        const notepadDiv = document.createElement("div");
        notepadDiv.innerHTML = `
          <div id="notepad-toolbar">
            <button onclick="execCmd('bold')"><b>B</b></button>
            <button onclick="execCmd('italic')"><i>I</i></button>
            <button onclick="execCmd('underline')"><u>U</u></button>
            Font: 
            <select id="font-select" onchange="changeFont(this.value)">
              <option value="Arial">Arial</option>
              <option value="Times New Roman">Times New Roman</option>
              <option value="Courier New">Courier New</option>
              <option value="Verdana">Verdana</option>
            </select>
          </div>
          <div id="notepad-area" contenteditable="true"></div>
        `;
        appContainer.appendChild(notepadDiv);
        // Restore saved notepad content
        document.getElementById("notepad-area").innerHTML = notepadContent;
        document.getElementById("notepad-area").addEventListener("input", function() {
          notepadContent = this.innerHTML;
          sendData("notepad", notepadContent);
        });
      } else if (appName === "tic-tac-toe") {
        const tttDiv = document.createElement("div");
        tttDiv.innerHTML = `
          <table id="ttt-board" style="border-collapse: collapse;">
            <tr>
              <td data-cell="0"></td>
              <td data-cell="1"></td>
              <td data-cell="2"></td>
            </tr>
            <tr>
              <td data-cell="3"></td>
              <td data-cell="4"></td>
              <td data-cell="5"></td>
            </tr>
            <tr>
              <td data-cell="6"></td>
              <td data-cell="7"></td>
              <td data-cell="8"></td>
            </tr>
          </table>
          <p id="ttt-status"></p>
        `;
        appContainer.appendChild(tttDiv);
        initTicTacToe();
      }
    }

    // Chat functions
    function renderChatHistory() {
      const chatWindow = document.getElementById("chat-window");
      if (chatWindow) {
        chatWindow.innerHTML = "";
        chatHistory.forEach(msg => {
          const p = document.createElement("p");
          p.textContent = msg;
          chatWindow.appendChild(p);
        });
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }
    }

    function appendChatMessage(msg) {
      chatHistory.push(msg);
      renderChatHistory();
    }

    // --- Tic Tac Toe App ---
    let tttBoard = Array(9).fill(null);
    let currentPlayer = "X";

    function initTicTacToe() {
      const cells = document.querySelectorAll("#ttt-board td");
      cells.forEach(cell => {
        cell.addEventListener("click", function() {
          const index = parseInt(this.getAttribute("data-cell"));
          if (!tttBoard[index]) {
            tttBoard[index] = currentPlayer;
            this.textContent = currentPlayer;
            sendData("tic-tac-toe", { index: index, player: currentPlayer });
            if (checkWin()) {
              document.getElementById("ttt-status").textContent = currentPlayer + " wins!";
            } else {
              currentPlayer = currentPlayer === "X" ? "O" : "X";
            }
          }
        });
      });
    }

    function handleTicTacToeMove(move) {
      if (typeof move.index === "number" && move.player) {
        tttBoard[move.index] = move.player;
        const cell = document.querySelector("#ttt-board td[data-cell='" + move.index + "']");
        if (cell) {
          cell.textContent = move.player;
        }
      }
    }

    function checkWin() {
      const winConditions = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],
        [0,4,8],[2,4,6]
      ];
      return winConditions.some(condition => {
        const [a, b, c] = condition;
        return tttBoard[a] && tttBoard[a] === tttBoard[b] && tttBoard[a] === tttBoard[c];
      });
    }

    // Notepad formatting functions
    function execCmd(cmd) {
      document.execCommand(cmd, false, null);
    }
    function changeFont(font) {
      document.execCommand('fontName', false, font);
    }
  </script>
</body>
</html>
