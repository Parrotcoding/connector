<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Device Connector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="styles.css">
  <!-- Load Poppins font from Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <header>
      <h1>Device Connector</h1>
    </header>
    
    <!-- Connection Section -->
    <div id="connection-section">
      <button id="create-session-btn" class="pill-btn">Create Session (Initiator)</button>
      <button id="join-session-btn" class="pill-btn">Join Session (Receiver)</button>
      <div id="signal-section" style="display:none;">
        <p id="signal-instructions">
          <strong>Step 1:</strong> Copy the short connection code below and send it to your peer.
        </p>
        <textarea id="signal-output" placeholder="Short connection code will appear here..." readonly></textarea>
        <p id="signal-paste">
          <strong>Step 2:</strong> Paste your peer's code below.
        </p>
        <textarea id="signal-input" placeholder="Paste remote connection code here"></textarea>
        <button id="submit-signal-btn" class="pill-btn">Submit Signal</button>
      </div>
    </div>

    <!-- Apps Section -->
    <div id="apps-section" style="display:none;">
      <!-- Home Screen: grid of app icons -->
      <div id="home-screen">
        <div class="home-icon" data-app="chat">
          <svg class="app-icon" viewBox="0 0 24 24">
            <path fill="currentColor" d="M20,2H4C2.897,2,2,2.897,2,4v16l4-4h14c1.103,0,2-0.897,2-2V4C22,2.897,21.103,2,20,2z"/>
          </svg>
          <span>Chat</span>
        </div>
        <div class="home-icon" data-app="notepad">
          <svg class="app-icon" viewBox="0 0 24 24">
            <path fill="currentColor" d="M19,2H8C6.897,2,6,2.897,6,4v16c0,1.103,0.897,2,2,2h11c1.103,0,2-0.897,2-2V4C21,2.897,20.103,2,19,2z M19,20H8V4h11V20z"/>
          </svg>
          <span>Notepad</span>
        </div>
        <div class="home-icon" data-app="calculator">
          <svg class="app-icon" viewBox="0 0 24 24">
            <rect x="3" y="2" width="18" height="20" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="2"/>
            <rect x="7" y="6" width="10" height="3" fill="currentColor"/>
          </svg>
          <span>Calculator</span>
        </div>
        <div class="home-icon" data-app="todo">
          <svg class="app-icon" viewBox="0 0 24 24">
            <path fill="none" stroke="currentColor" stroke-width="2" d="M4 7h16M4 12h16M4 17h16"/>
            <polyline fill="none" stroke="currentColor" stroke-width="2" points="8,5 9,6 11,4"/>
          </svg>
          <span>Todo List</span>
        </div>
        <div class="home-icon" data-app="doodle">
          <svg class="app-icon" viewBox="0 0 24 24">
            <path fill="none" stroke="currentColor" stroke-width="2" d="M3 21l18-18"/>
            <path fill="none" stroke="currentColor" stroke-width="2" d="M15 3l6 6"/>
            <path fill="none" stroke="currentColor" stroke-width="2" d="M4 13l3 3L21 5l-3-3L4 13z"/>
          </svg>
          <span>Doodle Board</span>
        </div>
        <div class="home-icon" data-app="pomodoro">
          <svg class="app-icon" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/>
            <line x1="12" y1="7" x2="12" y2="12" stroke="currentColor" stroke-width="2"/>
            <line x1="12" y1="12" x2="16" y2="14" stroke="currentColor" stroke-width="2"/>
          </svg>
          <span>Pomodoro</span>
        </div>
      </div>
      <!-- App Container: displays individual mini-app content -->
      <div id="app-container" style="display:none;"></div>
    </div>
  </div>

  <!-- Include SimplePeer and LZ-String -->
  <script src="https://unpkg.com/simple-peer/simplepeer.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
  <script>
    /* Global Variables */
    let peer;
    let currentRole = ""; // "initiator" or "receiver"
    let chatHistory = [];
    let notes = [{ title: "Note 1", content: "" }];
    let currentNoteIndex = 0;
    let drawings = [];
    let currentDrawingIndex = 0;
    let todoList = [];
    let pomodoroTime = 1500; // 25 minutes (in seconds)
    let pomodoroInterval = null;

    /* DOM Elements */
    const createSessionBtn = document.getElementById("create-session-btn");
    const joinSessionBtn = document.getElementById("join-session-btn");
    const signalSection = document.getElementById("signal-section");
    const signalOutput = document.getElementById("signal-output");
    const signalInput = document.getElementById("signal-input");
    const submitSignalBtn = document.getElementById("submit-signal-btn");
    const appsSection = document.getElementById("apps-section");
    const homeScreen = document.getElementById("home-screen");
    const appContainer = document.getElementById("app-container");

    /* Connection & Signaling */
    createSessionBtn.addEventListener("click", () => {
      currentRole = "initiator";
      startPeer(true);
      signalSection.style.display = "block";
    });
    joinSessionBtn.addEventListener("click", () => {
      currentRole = "receiver";
      startPeer(false);
      signalSection.style.display = "block";
    });
    submitSignalBtn.addEventListener("click", () => {
      const shortCode = signalInput.value;
      const decompressed = LZString.decompressFromEncodedURIComponent(shortCode);
      try {
        const signalData = JSON.parse(decompressed);
        peer.signal(signalData);
      } catch (e) {
        alert("Invalid connection code. Please ensure the code is correct.");
      }
    });
    function shortenSignal(text) {
      return LZString.compressToEncodedURIComponent(text);
    }
    function startPeer(isInitiator) {
      peer = new SimplePeer({ initiator: isInitiator, trickle: false });
      peer.on('signal', data => {
        const signalString = JSON.stringify(data);
        const shortCode = shortenSignal(signalString);
        signalOutput.value = shortCode;
      });
      peer.on('connect', () => {
        alert("Connection established!");
        document.getElementById("connection-section").style.display = "none";
        appsSection.style.display = "block";
        showHomeScreen();
      });
      peer.on('error', err => console.error("Peer error:", err));
      peer.on('data', data => {
        try {
          const message = JSON.parse(data);
          switch (message.app) {
            case "chat":
              appendChatMessage("Remote: " + message.payload);
              break;
            case "notepad":
              notes = message.payload;
              renderNotepadTabs();
              renderNotepadContent();
              break;
            case "calculator":
              updateCalculatorDisplay(message.payload);
              break;
            case "todo":
              todoList = message.payload;
              renderTodoList();
              break;
            case "doodle":
              handleDoodleData(message.payload);
              break;
            case "pomodoro":
              updatePomodoroDisplay(message.payload);
              break;
          }
        } catch (e) {
          console.error("Error parsing data:", e);
        }
      });
    }
    function sendData(app, payload) {
      const message = JSON.stringify({ app, payload });
      if (peer && peer.connected) {
        peer.send(message);
      }
    }

    /* Home Screen Navigation */
    function showHomeScreen() {
      homeScreen.style.display = "grid";
      appContainer.style.display = "none";
    }
    function openApp(appName) {
      homeScreen.style.display = "none";
      appContainer.style.display = "block";
      appContainer.innerHTML = `<button class="pill-btn back-btn" onclick="showHomeScreen()">Home</button>`;
      if (appName === "chat") {
        openChatApp();
      } else if (appName === "notepad") {
        openNotepadApp();
      } else if (appName === "calculator") {
        openCalculatorApp();
      } else if (appName === "todo") {
        openTodoApp();
      } else if (appName === "doodle") {
        openDoodleApp();
      } else if (appName === "pomodoro") {
        openPomodoroApp();
      }
    }
    document.querySelectorAll(".home-icon").forEach(icon => {
      icon.addEventListener("click", function() {
        openApp(this.dataset.app);
      });
    });

    /* ---------------------------
       Chat App
       --------------------------- */
    function openChatApp() {
      const chatDiv = document.createElement("div");
      chatDiv.innerHTML = `
        <div id="chat-window"></div>
        <input type="text" id="chat-input" placeholder="Type a message" />
        <button id="chat-send-btn" class="pill-btn">Send</button>
      `;
      appContainer.innerHTML += chatDiv.outerHTML;
      renderChatHistory();
      document.getElementById("chat-send-btn").addEventListener("click", () => {
        const message = document.getElementById("chat-input").value;
        if (message.trim() !== "") {
          appendChatMessage("You: " + message);
          sendData("chat", message);
          document.getElementById("chat-input").value = "";
        }
      });
    }
    function renderChatHistory() {
      const chatWindow = document.getElementById("chat-window");
      if (chatWindow) {
        chatWindow.innerHTML = "";
        chatHistory.forEach(msg => {
          const p = document.createElement("p");
          p.textContent = msg;
          chatWindow.appendChild(p);
        });
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }
    }
    function appendChatMessage(msg) {
      chatHistory.push(msg);
      renderChatHistory();
    }

    /* ---------------------------
       Notepad App with Tabs
       --------------------------- */
    function openNotepadApp() {
      const notepadDiv = document.createElement("div");
      notepadDiv.innerHTML = `
        <div id="notepad-tab-bar"></div>
        <button id="add-note-btn" class="pill-btn">Add Note</button>
        <div id="notepad-content" contenteditable="true"></div>
      `;
      appContainer.innerHTML += notepadDiv.outerHTML;
      renderNotepadTabs();
      renderNotepadContent();
      document.getElementById("notepad-content").addEventListener("input", function() {
        notes[currentNoteIndex].content = this.innerHTML;
        sendData("notepad", notes);
      });
      document.getElementById("add-note-btn").addEventListener("click", function() {
        notes.push({ title: "Note " + (notes.length + 1), content: "" });
        currentNoteIndex = notes.length - 1;
        renderNotepadTabs();
        renderNotepadContent();
        sendData("notepad", notes);
      });
    }
    function renderNotepadTabs() {
      const tabBar = document.getElementById("notepad-tab-bar");
      if (!tabBar) return;
      tabBar.innerHTML = "";
      notes.forEach((note, index) => {
        const tab = document.createElement("button");
        tab.textContent = note.title;
        tab.className = (index === currentNoteIndex) ? "active-note-tab" : "";
        tab.addEventListener("click", function() {
          currentNoteIndex = index;
          renderNotepadTabs();
          renderNotepadContent();
        });
        tabBar.appendChild(tab);
      });
    }
    function renderNotepadContent() {
      const contentArea = document.getElementById("notepad-content");
      if (contentArea) {
        contentArea.innerHTML = notes[currentNoteIndex].content;
      }
    }

    /* ---------------------------
       Calculator App
       --------------------------- */
    function openCalculatorApp() {
      const calcDiv = document.createElement("div");
      calcDiv.innerHTML = `
        <input type="text" id="calc-display" readonly placeholder="0" />
        <div id="calc-buttons">
          <button data-val="7" class="pill-btn">7</button>
          <button data-val="8" class="pill-btn">8</button>
          <button data-val="9" class="pill-btn">9</button>
          <button data-val="/" class="pill-btn">/</button>
          <button data-val="4" class="pill-btn">4</button>
          <button data-val="5" class="pill-btn">5</button>
          <button data-val="6" class="pill-btn">6</button>
          <button data-val="*" class="pill-btn">*</button>
          <button data-val="1" class="pill-btn">1</button>
          <button data-val="2" class="pill-btn">2</button>
          <button data-val="3" class="pill-btn">3</button>
          <button data-val="-" class="pill-btn">-</button>
          <button data-val="0" class="pill-btn">0</button>
          <button data-val="." class="pill-btn">.</button>
          <button id="calc-equals" class="pill-btn">=</button>
          <button data-val="+" class="pill-btn">+</button>
          <button id="calc-clear" class="pill-btn">C</button>
        </div>
      `;
      appContainer.innerHTML += calcDiv.outerHTML;
      const display = document.getElementById("calc-display");
      let expression = "";
      document.querySelectorAll("#calc-buttons button").forEach(btn => {
        btn.addEventListener("click", function() {
          const val = this.getAttribute("data-val");
          if (val) {
            expression += val;
            display.value = expression;
            sendData("calculator", expression);
          }
        });
      });
      document.getElementById("calc-equals").addEventListener("click", () => {
        try {
          const result = eval(expression);
          display.value = result;
          expression = result.toString();
          sendData("calculator", expression);
        } catch (e) {
          display.value = "Error";
          expression = "";
        }
      });
      document.getElementById("calc-clear").addEventListener("click", () => {
        expression = "";
        display.value = "";
        sendData("calculator", expression);
      });
    }
    function updateCalculatorDisplay(expr) {
      const display = document.getElementById("calc-display");
      if (display) { display.value = expr; }
    }

    /* ---------------------------
       Todo List App
       --------------------------- */
    function openTodoApp() {
      const todoDiv = document.createElement("div");
      todoDiv.innerHTML = `
        <input type="text" id="todo-input" placeholder="New task" />
        <button id="add-todo-btn" class="pill-btn">Add Task</button>
        <ul id="todo-list"></ul>
      `;
      appContainer.innerHTML += todoDiv.outerHTML;
      document.getElementById("add-todo-btn").addEventListener("click", () => {
        const taskInput = document.getElementById("todo-input");
        if (taskInput.value.trim() !== "") {
          todoList.push({ text: taskInput.value, done: false });
          taskInput.value = "";
          renderTodoList();
          sendData("todo", todoList);
        }
      });
      renderTodoList();
    }
    function renderTodoList() {
      const todoUl = document.getElementById("todo-list");
      if (todoUl) {
        todoUl.innerHTML = "";
        todoList.forEach((task, index) => {
          const li = document.createElement("li");
          li.textContent = task.text;
          li.style.textDecoration = task.done ? "line-through" : "none";
          li.addEventListener("click", () => {
            todoList[index].done = !todoList[index].done;
            renderTodoList();
            sendData("todo", todoList);
          });
          todoUl.appendChild(li);
        });
      }
    }

    /* ---------------------------
       Doodle Board App with Tabs
       --------------------------- */
    function openDoodleApp() {
      const doodleDiv = document.createElement("div");
      doodleDiv.innerHTML = `
        <div id="doodle-tab-bar"></div>
        <button id="add-drawing-btn" class="pill-btn">Add Drawing</button>
        <canvas id="doodle-canvas" width="300" height="200"></canvas>
      `;
      appContainer.innerHTML += doodleDiv.outerHTML;
      if (drawings.length === 0) {
        drawings.push(null);
        currentDrawingIndex = 0;
      }
      renderDoodleTabs();
      initDoodleBoard();
      document.getElementById("add-drawing-btn").addEventListener("click", function() {
        drawings.push(null);
        currentDrawingIndex = drawings.length - 1;
        renderDoodleTabs();
        const canvas = document.getElementById("doodle-canvas");
        if (canvas) {
          const ctx = canvas.getContext("2d");
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        sendData("doodle", { action: "newDrawing", index: currentDrawingIndex });
      });
    }
    function renderDoodleTabs() {
      const tabBar = document.getElementById("doodle-tab-bar");
      if (!tabBar) return;
      tabBar.innerHTML = "";
      drawings.forEach((drawing, index) => {
        const tab = document.createElement("button");
        tab.textContent = "Drawing " + (index + 1);
        tab.className = (index === currentDrawingIndex) ? "active-doodle-tab" : "";
        tab.addEventListener("click", function() {
          currentDrawingIndex = index;
          renderDoodleTabs();
          const canvas = document.getElementById("doodle-canvas");
          const ctx = canvas.getContext("2d");
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          if (drawings[index]) {
            const img = new Image();
            img.onload = function() {
              ctx.drawImage(img, 0, 0);
            }
            img.src = drawings[index];
          }
        });
        tabBar.appendChild(tab);
      });
    }
    function initDoodleBoard() {
      const canvas = document.getElementById("doodle-canvas");
      const ctx = canvas.getContext("2d");
      let drawing = false;
      let lastX, lastY;
      canvas.addEventListener("mousedown", (e) => {
        drawing = true;
        [lastX, lastY] = [e.offsetX, e.offsetY];
      });
      canvas.addEventListener("mousemove", (e) => {
        if (!drawing) return;
        const x = e.offsetX, y = e.offsetY;
        drawLine(ctx, lastX, lastY, x, y);
        sendData("doodle", { action: "draw", index: currentDrawingIndex, from: { x: lastX, y: lastY }, to: { x, y } });
        [lastX, lastY] = [x, y];
        drawings[currentDrawingIndex] = canvas.toDataURL();
      });
      canvas.addEventListener("mouseup", () => drawing = false);
      canvas.addEventListener("mouseout", () => drawing = false);
      canvas.addEventListener("touchstart", (e) => {
        e.preventDefault();
        drawing = true;
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        lastX = touch.clientX - rect.left;
        lastY = touch.clientY - rect.top;
      });
      canvas.addEventListener("touchmove", (e) => {
        e.preventDefault();
        if (!drawing) return;
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        drawLine(ctx, lastX, lastY, x, y);
        sendData("doodle", { action: "draw", index: currentDrawingIndex, from: { x: lastX, y: lastY }, to: { x, y } });
        [lastX, lastY] = [x, y];
        drawings[currentDrawingIndex] = canvas.toDataURL();
      });
      canvas.addEventListener("touchend", () => drawing = false);
    }
    function drawLine(ctx, x1, y1, x2, y2) {
      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      ctx.strokeStyle = "#000";
      ctx.lineWidth = 2;
      ctx.stroke();
    }
    function handleDoodleData(payload) {
      const canvas = document.getElementById("doodle-canvas");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      if (payload.action === "draw") {
        if (payload.index === currentDrawingIndex) {
          drawLine(ctx, payload.from.x, payload.from.y, payload.to.x, payload.to.y);
          drawings[currentDrawingIndex] = canvas.toDataURL();
        }
      } else if (payload.action === "newDrawing") {
        if (!drawings[payload.index]) {
          drawings[payload.index] = null;
          renderDoodleTabs();
        }
      }
    }

    /* ---------------------------
       Pomodoro Timer App
       --------------------------- */
    function openPomodoroApp() {
      const pomodoroDiv = document.createElement("div");
      pomodoroDiv.innerHTML = `
        <div id="pomodoro-display">25:00</div>
        <div id="pomodoro-buttons">
          <button id="pomodoro-start" class="pill-btn">Start</button>
          <button id="pomodoro-pause" class="pill-btn">Pause</button>
          <button id="pomodoro-reset" class="pill-btn">Reset</button>
        </div>
      `;
      appContainer.innerHTML += pomodoroDiv.outerHTML;
      document.getElementById("pomodoro-start").addEventListener("click", startPomodoro);
      document.getElementById("pomodoro-pause").addEventListener("click", pausePomodoro);
      document.getElementById("pomodoro-reset").addEventListener("click", resetPomodoro);
    }
    function startPomodoro() {
      if (pomodoroInterval) return;
      pomodoroInterval = setInterval(() => {
        if (pomodoroTime > 0) {
          pomodoroTime--;
          updatePomodoroDisplay(formatTime(pomodoroTime));
          sendData("pomodoro", formatTime(pomodoroTime));
        } else {
          clearInterval(pomodoroInterval);
          pomodoroInterval = null;
          alert("Time's up!");
        }
      }, 1000);
    }
    function pausePomodoro() {
      clearInterval(pomodoroInterval);
      pomodoroInterval = null;
    }
    function resetPomodoro() {
      pausePomodoro();
      pomodoroTime = 1500;
      updatePomodoroDisplay(formatTime(pomodoroTime));
      sendData("pomodoro", formatTime(pomodoroTime));
    }
    function updatePomodoroDisplay(text) {
      const display = document.getElementById("pomodoro-display");
      if (display) { display.textContent = text; }
    }
    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return `${m < 10 ? "0" + m : m}:${s < 10 ? "0" + s : s}`;
    }

    /* ---------------------------
       Notepad Formatting Functions
       --------------------------- */
    function execCmd(cmd) {
      document.execCommand(cmd, false, null);
    }
    function changeFont(font) {
      document.execCommand('fontName', false, font);
    }
  </script>

  <!--
  ===============================
  Guide & Instructions
  ===============================
  1. Setup:
     - Serve these files via HTTPS or on localhost (e.g., using "python -m http.server").
     - Open index.html on a device.
     - For best experience, add Device Connector to your Home Screen.
  2. Landing Page:
     - When opened in a browser, the landing page shows instructions to add the app to your Home Screen.
     - When added to the Home Screen, the landing page launches full screen.
     - Click "Enter App" to proceed.
  3. In App Mode:
     - Establish a connection by creating or joining a session (connection codes are shortened).
     - After connecting, you’ll see a home screen grid of app icons.
     - Tap an icon to open that mini‑app. Use the "Home" button to return.
        • Chat: Exchange messages.
        • Notepad: Create multiple notes using internal tabs and formatting.
        • Calculator: Enter expressions and view results.
        • Todo List: Add tasks and mark them complete.
        • Doodle Board: Draw on the canvas and manage multiple drawings.
        • Pomodoro: Use the timer for productivity sessions.
  Enjoy your Device Connector experience!
  ===============================
  -->
</body>
</html>
